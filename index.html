<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Web Serial</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@3.3.10/dist/vuetify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css"/>
</head>
<body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/makeabilitylab/p5js/_libraries/serial.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.10/dist/vuetify.min.js"></script>
        <div id="app">
            <h1>Arduino Fan Controller</h1>
            <p>Fan speed controller via Serial connection to Arduino. Utilizes IR communication through an Arduino Uno.</p>
            <v-btn class="ma-4" @click="onConnect()">Connect via Serial</v-btn>
            <v-switch class="ma-4" v-model="power" label="Power-On"></v-switch>

            <v-radio-group v-model="fanSpeed" :disabled="!power">
                <v-radio label="Eco" :value="2"></v-radio>
                <v-radio label="Low" :value="3"></v-radio>
                <v-radio label="Medium" :value="4"></v-radio>
                <v-radio label="High" :value="5"></v-radio>
              </v-radio-group>

            <v-switch v-model="rotate" label="Enable Rotation" :disabled="!power"></v-switch>
        </div>
    <script>
        const { createApp, ref, watch } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify();

        createApp({
        setup() {
            const power = ref(false);
            const rotate = ref(false);
            const fanSpeed = ref(2);

            const serial = new Serial();
            serial.on(SerialEvents.CONNECTION_OPENED, onSerialConnectionOpened);
            serial.on(SerialEvents.CONNECTION_CLOSED, onSerialConnectionClosed);
            serial.on(SerialEvents.DATA_RECEIVED, onSerialDataReceived);
            serial.on(SerialEvents.ERROR_OCCURRED, onSerialErrorOccurred);

            watch(fanSpeed, (speed)=>{
                onFanSpeedChange(speed);
            },
            { deep: true }
            );

            watch(rotate, (r)=>{
                onFanSpeedChange(fanSpeed.value);
            },
            { deep: true }
            );

            watch(power, (p)=>{
                p?powerOn():powerOff();
            },
            { deep: true }
            );

            async function onConnect(){
                console.log('connect button clicked!');

                if (navigator.serial) {
                    if (!serial.isOpen()) {
                    await serial.connectAndOpen();
                    } else {
                    console.log("The serial connection appears already open");
                    }
                } 
                else {
                    alert('The Web Serial API does not appear supported on this web browser.');
                }
            };
            async function powerOn(){
                power.value = true;
                returnValue = 1;
                console.log("Sending Power-on signal over serial: ", returnValue.toString());
                                
                if(!serial.serialWriter){
                    console.log("Please initialize serial connection", serial);
                }
                else{
                    serial.writeLine(returnValue);
                }
            };
            async function powerOff(){
                power.value = false;
                returnValue= 0 ;
                console.log("Sending Power-off signal over serial: ", returnValue.toString());
                
                if(!serial.serialWriter){
                    console.log("Please initialize serial connection", serial);
                }
                else{
                    serial.writeLine(returnValue);
                }
            };
            async function onFanSpeedChange(fanSpeed) {
                let  returnValue = rotate.value ? (parseInt(fanSpeed) + 4) : fanSpeed; //offsets to access roation commands
                console.log("Writing to serial: ", returnValue.toString());
                //serial.writeLine(returnValue);
            }

            function onSerialErrorOccurred(eventSender, error) {
                console.log("onSerialErrorOccurred", error);
            }

            function onSerialConnectionOpened(eventSender) {
                console.log("onSerialConnectionOpened", eventSender);
            }

            function onSerialConnectionClosed(eventSender) {
                console.log("onSerialConnectionClosed", eventSender);
            }

            function onSerialDataReceived(eventSender, newData) {
                console.log("onSerialDataReceived", newData);
            }

            return {
            rotate,
            fanSpeed,
            power,
            onConnect,
            onFanSpeedChange,
            onSerialErrorOccurred,
            onSerialConnectionOpened,
            onSerialConnectionClosed,
            onSerialDataReceived,
            powerOn,
            powerOff
            }
        }
        }).use(vuetify).mount('#app')

    </script>
</body>
</html>