<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arduino Web Serial</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/gh/makeabilitylab/p5js/_libraries/serial.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <div id="app">
        <h1>{{message}}</h1>
        <p>Fan speed controller via Serial connection to Arduino. Utilizes IR communication through an Arduino Uno.</p>
        <button id="connectButton" onclick="onConnect()">Connect via serial port</button><br>
        
        <input id="slider" type="range" min="2" max="5" 
        value="128" onchange="onSliderValueChanged(this, event)" /><br>

        <input type="radio" id="eco" name="fanSpeed" value="2">
        <label for="eco">Eco</label><br>
        <input type="radio" id="low" name="fanSpeed" value="3">
        <label for="low">Low</label><br>
        <input type="radio" id="med" name="fanSpeed" value="4">
        <label for="med">Medium</label><br>
        <input type="radio" id="high" name="fanSpeed" value="5">
        <label for="high">High</label><br>

        <input type="checkbox" id="rotateButton" onchange="rotate=!rotate; onSliderValueChanged(slider)">Rotation</button>
    </div>
    <script type="module">
        
        import { createApp, ref } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
        
        var rotate = false;

        createApp({
            setup() {

            const message = ref('Arduino Fan Controller');

            return {
                message
            }

            }
        }).mount('#app')


        const serial = new Serial();
        serial.on(SerialEvents.CONNECTION_OPENED, onSerialConnectionOpened);
        serial.on(SerialEvents.CONNECTION_CLOSED, onSerialConnectionClosed);
        serial.on(SerialEvents.DATA_RECEIVED, onSerialDataReceived);
        serial.on(SerialEvents.ERROR_OCCURRED, onSerialErrorOccurred);

        async function onConnect(){
            console.log('connect button clicked!');

            if (navigator.serial) {
                if (!serial.isOpen()) {
                await serial.connectAndOpen();
                } else {
                console.log("The serial connection appears already open");
                }
            } 
            else {
                alert('The Web Serial API does not appear supported on this web browser.');
            }
        };
        async function onSliderValueChanged(src, event) {
            let  returnValue = rotate? (parseInt(src.value) + 4) : src.value; //offsets to access roation commands
            console.log(returnValue, typeof(returnValue));
            console.log("Writing to serial: ", returnValue.toString());
            serial.writeLine(returnValue);
        }

        function onSerialErrorOccurred(eventSender, error) {
            console.log("onSerialErrorOccurred", error);
        }

        function onSerialConnectionOpened(eventSender) {
            console.log("onSerialConnectionOpened", eventSender);
        }

        function onSerialConnectionClosed(eventSender) {
            console.log("onSerialConnectionClosed", eventSender);
        }

        function onSerialDataReceived(eventSender, newData) {
            console.log("onSerialDataReceived", newData);
        }

    </script>
</body>
</html>